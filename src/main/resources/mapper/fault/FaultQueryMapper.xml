<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wzmtr.eam.mapper.fault.FaultQueryMapper">

    <sql id="query-cols">
        SELECT
        d.REC_ID AS "faultInfoRecId",
        df.REC_ID AS "faultOrderRecId",
        df.WORK_CLASS AS "workClass",
        d.COMPANY_CODE AS "companyCode",
        d.COMPANY_NAME AS "companyName",
        d.FAULT_NO AS "faultNo",
        d.FAULT_FLAG AS "faultFlag",
        d.OBJECT_CODE AS "objectCode",
        d.OBJECT_CODE AS "objectCode_textField",
        d.OBJECT_NAME AS "objectName",
        d.TRAIN_TRUNK AS "trainTrunk",
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line') AS "lineName",
        d.LINE_CODE AS "lineCode",
        d.POSITION_CODE AS "positionCode",
        d.POSITION2_CODE AS "position2Code",
        d.PART_CODE AS "partCode",
        d.PART_NAME AS "partName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS "majorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS "systemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS "equipTypeName",
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS "stationCode",
        d.MAJOR_CODE AS "majorCode",
        d.SYSTEM_CODE AS "systemCode",
        d.EQUIP_TYPE_CODE AS "equipTypeCode",
        d.FAULT_MODULE AS "faultModule",
        d.FAULT_MODULE_ID AS "faultModuleId",
        d.FAULT_TYPE AS "faultType",
        d.SOURCE_CODE AS "sourceCode",
        d.FAULT_DISPLAY_CODE AS "faultDisplayCode",
        d.FAULT_DISPLAY_DETAIL AS "faultDisplayDetail",
        d.FAULT_DETAIL AS "faultDetail",
        d.DISCOVERER_ID AS "discovererId",
        d.DISCOVERER_PHONE AS "discovererPhone",
        d.DISCOVERER_NAME AS "discovererName",
        d.DISCOVERY_TIME AS "discoveryTime",
        d.FILLIN_USER_ID AS "fillinUserId",
        d.FILLIN_DEPT_CODE AS "fillinDeptCode",
        d.FILLIN_TIME AS "fillinTime",
        d.RESP_DEPT_CODE AS "respDeptCode",
        d.ASSIST_DEPT_CODE AS "assistDeptCode",
        d.REPAIR_DEPT_CODE AS "repairDeptCode",
        d.PUBLISH_USER_ID AS "publishUserId",
        d.PUBLISH_TIME AS "publishTime",
        (CASE WHEN d.FAULT_LEVEL!=' ' THEN d.FAULT_LEVEL ELSE df.EXT1 END) AS "faultLevel",
        d.FAULT_STATUS AS "faultStatus",
        d.WORK_FLOW_INST_ID AS "workFlowInstId",
        d.WORK_FLOW_INST_STATUS AS "workFlowInstStatus",
        d.DOC_ID AS "docId",
        d.REMARK AS "remark",
        d.REC_CREATOR AS "recCreator",
        d.REC_CREATE_TIME AS "recCreateTime",
        d.REC_REVISOR AS "recRevisor",
        d.REC_REVISE_TIME AS "recReviseTime",
        d.REC_DELETOR AS "recDeletor",
        d.REC_DELETE_TIME AS "recDeleteTime",
        d.DELETE_FLAG AS "deleteFlag",
        d.ARCHIVE_FLAG AS "archiveFlag",
        d.REC_STATUS AS "recStatus",
        d.EXT1 AS "ext1",
        d.EXT2 AS "ext2",
        d.EXT3 AS "affect",
        d.EXT4 AS "ext4",
        d.EXT5 AS "ext5",
        d.TRAIN_TAG AS "traintag",
        (case when d.FILLIN_USER_NAME is null then u.NAME else d.FILLIN_USER_NAME end) AS "fillinUserName",
        df.CLOSE_TIME AS "closeTime",
        (SELECT u1.NAME FROM SYS_USER u1 WHERE u1.LOGIN_NAME=df.CLOSE_USER_ID) AS "closeUserName",
        df.DEALER_UNIT AS "dealerUnit",
        df.FAULT_PROCESS_RESULT AS "faultProcessResult",
        df.DEALER_NUM AS "dealerNum",
        df.FAULT_WORK_NO AS "faultWorkNo",
        df.REC_ID AS "orderRecId",
        df.ORDER_STATUS AS "orderStatus",
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        df.EXT1 AS "levelfault",
        df.FAULT_AFFECT AS "faultAffect",
        (CASE WHEN df.ORDER_STATUS='99' THEN '1' ELSE '0' END) sort
        FROM T_FAULT_INFO d
        LEFT JOIN SYS_USER u ON d.FILLIN_USER_ID=u.LOGIN_NAME
        LEFT JOIN T_FAULT_ORDER df ON d.FAULT_NO=df.FAULT_NO
    </sql>

    <!--dmfm01.query -->
    <select id="query" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        <include refid="query-cols"/>
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="req.faultType!=null and req.faultType!=''">
                AND d.FAULT_TYPE=#{req.faultType}
            </if>
            <if test="req.positionCode!=null and req.positionCode!=''">
                AND d.POSITION_CODE=#{req.positionCode}
            </if>
            <if test="req.faultNo!=null and req.faultNo!=''">
                AND d.FAULT_NO=#{req.faultNo}
            </if>
            <if test="req.faultWorkNo!=null and req.faultWorkNo!=''">
                AND df.FAULT_WORK_NO =#{req.faultWorkNo}
            </if>
            <if test="req.orderStatus!=null and req.orderStatus!=''">
                AND df.ORDER_STATUS=#{req.orderStatus}
            </if>
            <if test="req.orderStatusList!=null and req.orderStatusList.size()>0">
                AND df.ORDER_STATUS IN (
                <foreach collection="req.orderStatusList" index="index" item="status" separator=",">
                    #{status}
                </foreach>
                )
            </if>
            <if test="req.invalid!=null and 'true'.toString()==req.invalid.toString()">
                AND df.ORDER_STATUS='99'
            </if>
            <if test="req.lineCode!=null and req.lineCode!=''">
                AND d.LINE_CODE=#{req.lineCode}
            </if>
            <if test="req.objectCode!=null and req.objectCode!=''">
                AND d.OBJECT_CODE=#{req.objectCode}
            </if>
            <if test="req.objectName!=null and req.objectName!=''">
                AND d.OBJECT_NAME=#{req.objectName}
            </if>
            <if test="req.majorCode!=null and req.majorCode!=''">
                AND d.MAJOR_CODE=#{req.majorCode}
            </if>
            <if test="majors!=null and majors.size()>0">
                AND d.MAJOR_CODE IN (
                <foreach collection="majors" index="index" item="major" separator=",">
                    #{major}
                </foreach>
                )
            </if>
            <if test="req.systemCode!=null and req.systemCode!=''">
                AND d.SYSTEM_CODE=#{req.systemCode}
            </if>
            <if test="req.equipTypeCode!=null and req.equipTypeCode!=''">
                AND d.EQUIP_TYPE_CODE=#{req.equipTypeCode}
            </if>
            <if test="req.faultDetail!=null and req.faultDetail!=''">
                AND d.FAULT_DETAIL LIKE '%' || #{req.faultDetail} || '%'
            </if>
            <if test="req.fillinTimeStart!=null and req.fillinTimeStart!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{req.fillinTimeStart}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="req.fillinTimeEnd!=null and req.fillinTimeEnd!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{req.fillinTimeEnd}, 'yyyy-mm-dd hh24:mi:ss') + 1
            </if>
            <if test="req.levelfault!=null and req.levelfault!=''">
                AND df.EXT1=#{req.levelfault}
            </if>
            AND d.FAULT_FLAG!='2' AND d.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        </trim>
        ORDER BY sort asc, d.FAULT_NO desc, df.FAULT_WORK_NO desc
    </select>

    <select id="queryByEngineer" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        <include refid="query-cols"/>
        WHERE df.ORDER_STATUS IN ('50', '55', '60', '70')
        <if test="majors!=null and majors.size()>0">
            and d.MAJOR_CODE IN (
            <foreach collection="majors" index="index" item="major" separator=",">
                #{major}
            </foreach>
            )
        </if>
        AND d.FAULT_FLAG!='2' AND d.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        ORDER BY sort asc, d.FAULT_NO desc, df.FAULT_WORK_NO desc
    </select>

    <select id="queryByUser" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        <include refid="query-cols"/>
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="req.faultType!=null and req.faultType!=''">
                AND d.FAULT_TYPE=#{req.faultType}
            </if>
            <if test="req.positionCode!=null and req.positionCode!=''">
                AND d.POSITION_CODE=#{req.positionCode}
            </if>
            <if test="req.faultNo!=null and req.faultNo!=''">
                AND d.FAULT_NO=#{req.faultNo}
            </if>
            <if test="req.faultWorkNo!=null and req.faultWorkNo!=''">
                AND df.FAULT_WORK_NO =#{req.faultWorkNo}
            </if>
            <if test="req.orderStatus!=null and req.orderStatus!=''">
                AND df.ORDER_STATUS=#{req.orderStatus}
            </if>
            <if test="req.orderStatusList!=null and req.orderStatusList.size()>0">
                AND df.ORDER_STATUS IN (
                <foreach collection="req.orderStatusList" index="index" item="orderStatus" separator=",">
                    #{orderStatus}
                </foreach>
                )
            </if>
            <if test="req.invalid!=null and 'true'.toString()==req.invalid.toString()">
                AND df.ORDER_STATUS='99'
            </if>
            <if test="req.lineCode!=null and req.lineCode!=''">
                AND d.LINE_CODE=#{req.lineCode}
            </if>
            <if test="req.objectCode!=null and req.objectCode!=''">
                AND d.OBJECT_CODE=#{req.objectCode}
            </if>
            <if test="req.objectName!=null and req.objectName!=''">
                AND d.OBJECT_NAME=#{req.objectName}
            </if>
            <if test="req.majorCode!=null and req.majorCode!=''">
                AND d.MAJOR_CODE=#{req.majorCode}
            </if>
            <if test="majors!=null and majors.size()>0">
                and d.MAJOR_CODE IN (
                <foreach collection="majors" index="index" item="major" separator=",">
                    #{major}
                </foreach>
                )
            </if>
            <if test="req.systemCode!=null and req.systemCode!=''">
                AND d.SYSTEM_CODE=#{req.systemCode}
            </if>
            <if test="req.equipTypeCode!=null and req.equipTypeCode!=''">
                AND d.EQUIP_TYPE_CODE=#{req.equipTypeCode}
            </if>
            <if test="req.faultDetail!=null and req.faultDetail!=''">
                AND d.FAULT_DETAIL LIKE '%' || #{req.faultDetail} || '%'
            </if>
            <if test="req.fillinTimeStart!=null and req.fillinTimeStart!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{req.fillinTimeStart}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="req.fillinTimeEnd!=null and req.fillinTimeEnd!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{req.fillinTimeEnd}, 'yyyy-mm-dd hh24:mi:ss') + 1
            </if>
            <if test="req.levelfault!=null and req.levelfault!=''">
                AND df.EXT1=#{req.levelfault}
            </if>
            <if test="userId!=null">
                AND (df.DISPATCH_USER_ID=#{userId} OR
                <if test="officeAreaId!=null and officeAreaId!=''">
                    d.REPAIR_DEPT_CODE=#{officeAreaId} OR
                </if>
                df.REPAIR_RESP_USER_ID=#{userId} OR df.REPORT_USER_ID=#{userId} OR
                df.REPORT_START_USER_ID=#{userId} OR df.REPORT_FINISH_USER_ID=#{userId} OR
                df.CHECK_USER_ID=#{userId} OR df.CONFIRM_USER_ID=#{userId} OR df.CLOSE_USER_ID=#{userId} OR
                df.CANCEL_USER_ID=#{userId} OR df.REC_CREATOR=#{userId}
                <if test="type!=null and type=='1'.toString()">
                    OR df.ORDER_STATUS IN ('50', '55', '60', '70')
                </if>
                <if test="type!=null and type=='2'.toString()">
                    OR d.EXT4='true'
                </if>
                )
            </if>
            <if test="userStations!=null and userStations.size()>0">
                AND (
                <foreach collection="userStations" index="index" item="userStation" separator="OR">
                    d.REC_STATION LIKE '%' || #{userStation} || '%'
                </foreach>
                )
            </if>
            AND d.FAULT_FLAG!='2' AND d.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        </trim>
        ORDER BY sort asc, d.FAULT_NO desc, df.FAULT_WORK_NO desc
    </select>

    <select id="queryLimit" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        SELECT
        df.FAULT_WORK_NO AS "faultWorkNo",
        df.ORDER_STATUS AS "orderStatus"
        FROM T_FAULT_ORDER df
        LEFT JOIN T_FAULT_INFO d ON d.FAULT_NO=df.FAULT_NO
        LEFT JOIN SYS_USER u ON df.REPAIR_RESP_USER_ID = u.LOGIN_NAME
        <trim prefix="WHERE" prefixOverrides="AND">
            AND df.ORDER_STATUS='30' <!-- 查询在派工中的 -->
            <if test="userDept!=null and userDept!=''">
                AND u.OFFICE_ID=#{userDept}
            </if>
            <if test="majors!=null and majors.size()>0">
                and d.MAJOR_CODE IN (
                <foreach collection="majors" index="index" item="major" separator=",">
                    #{major}
                </foreach>
                )
            </if>
            AND SYSDATE >= to_date(df.REPAIR_LIMIT_TIME, 'YYYY-MM-DD HH24:MI:SS')
            AND d.FAULT_FLAG!='2' AND df.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        </trim>
        ORDER BY df.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>

    <select id="statustucQuery" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        SELECT
        d.REC_ID AS "faultInfoRecId",
        df.REC_ID AS "faultOrderRecId",
        df.WORK_CLASS AS "workClass",
        d.COMPANY_CODE AS "companyCode",
        d.COMPANY_NAME AS "companyName",
        d.FAULT_NO AS "faultNo",
        d.FAULT_FLAG AS "faultFlag",
        d.OBJECT_CODE AS "objectCode",
        d.OBJECT_CODE AS "objectCode_textField",
        d.OBJECT_NAME AS "objectName",
        d.TRAIN_TRUNK AS "trainTrunk",
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line')
        AS
        "lineName",
        d.LINE_CODE AS "lineCode",
        d.POSITION_CODE AS "positionCode",
        d.POSITION2_CODE AS "position2Code",
        d.PART_CODE AS "partCode",
        d.PART_NAME AS "partName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS "majorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS "systemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS "equipTypeName",
        (select u.NAME from SYS_USER u where u.LOGIN_NAME=trim(df.REPORT_FINISH_USER_ID)) as "reportFinishUserName",
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS "stationCode",
        df.REPORT_FINISH_TIME as reportFinishTime,
        d.MAJOR_CODE AS "majorCode",
        d.SYSTEM_CODE AS "systemCode",
        d.EQUIP_TYPE_CODE AS "equipTypeCode",
        d.FAULT_MODULE AS "faultModule",
        d.FAULT_MODULE_ID AS "faultModuleId",
        d.FAULT_TYPE AS "faultType",
        d.SOURCE_CODE AS "sourceCode",
        d.FAULT_DISPLAY_CODE AS "faultDisplayCode",
        d.FAULT_DISPLAY_DETAIL AS "faultDisplayDetail",
        d.FAULT_DETAIL AS "faultDetail",
        d.DISCOVERER_ID AS "discovererId",
        d.DISCOVERER_PHONE AS "discovererPhone",
        d.DISCOVERER_NAME AS "discovererName",
        d.DISCOVERY_TIME AS "discoveryTime",
        d.FILLIN_USER_ID AS "fillinUserId",
        d.FILLIN_DEPT_CODE AS "fillinDeptCode",
        d.FILLIN_TIME AS "fillinTime",
        d.RESP_DEPT_CODE AS "respDeptCode",
        d.ASSIST_DEPT_CODE AS "assistDeptCode",
        d.REPAIR_DEPT_CODE AS "repairDeptCode",
        d.PUBLISH_USER_ID AS "publishUserId",
        d.PUBLISH_TIME AS "publishTime",
        d.FAULT_STATUS AS "faultStatus",
        d.WORK_FLOW_INST_ID AS "workFlowInstId",
        d.WORK_FLOW_INST_STATUS AS "workFlowInstStatus",
        d.DOC_ID AS "docId",
        d.REMARK AS "remark",
        d.REC_CREATOR AS "recCreator",
        d.REC_CREATE_TIME AS "recCreateTime",
        d.REC_REVISOR AS "recRevisor",
        d.REC_REVISE_TIME AS "recReviseTime",
        d.REC_DELETOR AS "recDeletor",
        d.REC_DELETE_TIME AS "recDeleteTime",
        d.DELETE_FLAG AS "deleteFlag",
        d.ARCHIVE_FLAG AS "archiveFlag",
        d.REC_STATUS AS "recStatus",
        d.EXT1 AS "ext1",
        d.EXT2 AS "ext2",
        d.EXT3 AS "affect",
        d.EXT4 AS "ext4",
        d.EXT5 AS "ext5",
        d.TRAIN_TAG AS "traintag",
        (case when d.FILLIN_USER_NAME is null then u.NAME else d.FILLIN_USER_NAME end) AS "fillinUserName",
        df.CLOSE_TIME AS "closeTime",
        (SELECT u1.NAME FROM SYS_USER u1 WHERE u1.LOGIN_NAME=df.CLOSE_USER_ID) AS "closeUserName",
        df.DEALER_UNIT AS "dealerUnit",
        df.FAULT_PROCESS_RESULT AS "faultProcessResult",
        df.DEALER_NUM AS "dealerNum",
        df.FAULT_WORK_NO AS "faultWorkNo",
        df.REC_ID AS "orderRecId",
        df.ORDER_STATUS AS "orderStatus",
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        df.EXT1 AS "faultLevel"
        FROM T_FAULT_INFO d
        LEFT JOIN SYS_USER u ON d.FILLIN_USER_ID=u.LOGIN_NAME
        LEFT JOIN T_FAULT_ORDER df ON d.FAULT_NO=df.FAULT_NO
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="req.faultType!=null and req.faultType!=''">
                AND d.FAULT_TYPE=#{req.faultType}
            </if>
            <if test="req.positionCode!=null and req.positionCode!=''">
                AND d.POSITION_CODE=#{req.positionCode}
            </if>
            <if test="req.faultNo!=null and req.faultNo!=''">
                AND d.FAULT_NO=#{req.faultNo}
            </if>
            <if test="req.faultWorkNo!=null and req.faultWorkNo!=''">
                AND df.FAULT_WORK_NO =#{req.faultWorkNo}
            </if>
            <if test="req.orderStatus!=null and req.orderStatus!=''">
                AND df.ORDER_STATUS=#{req.orderStatus}
            </if>
            <if test="req.invalid!=null and 'true'.toString()==req.invalid.toString()">
                AND df.ORDER_STATUS='99'
            </if>
            <if test="req.lineCode!=null and req.lineCode!=''">
                AND d.LINE_CODE=#{req.lineCode}
            </if>
            <if test="req.objectCode!=null and req.objectCode!=''">
                AND d.OBJECT_CODE=#{req.objectCode}
            </if>
            <if test="req.objectName!=null and req.objectName!=''">
                AND d.OBJECT_NAME=#{req.objectName}
            </if>
            <if test="req.majorCode!=null and req.majorCode!=''">
                AND d.MAJOR_CODE=#{req.majorCode}
            </if>
            <if test="req.systemCode!=null and req.systemCode!=''">
                AND d.SYSTEM_CODE=#{req.systemCode}
            </if>
            <if test="req.equipTypeCode!=null and req.equipTypeCode!=''">
                AND d.EQUIP_TYPE_CODE=#{req.equipTypeCode}
            </if>
            <if test="req.faultDetail!=null and req.faultDetail!=''">
                AND d.FAULT_DETAIL LIKE '%' || #{req.faultDetail} || '%'
            </if>
            <if test="req.fillinTimeStart!=null and req.fillinTimeStart!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{req.fillinTimeStart}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="req.fillinTimeEnd!=null and req.fillinTimeEnd!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{req.fillinTimeEnd}, 'yyyy-mm-dd hh24:mi:ss') + 1
            </if>
            <if test="req.levelfault!=null and req.levelfault!=''">
                AND df.EXT1=#{req.levelfault}
            </if>
<!--            <if test="req.listType==null">-->
<!--                AND (d.FILLIN_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and-->
<!--                d.RESP_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and-->
<!--                d.ASSIST_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and-->
<!--                d.REPAIR_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%'))-->
<!--            </if>-->
<!--            <if test="req.listType!=null">-->
<!--                AND (d.FILLIN_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or-->
<!--                d.RESP_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or-->
<!--                d.ASSIST_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or-->
<!--                d.REPAIR_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%'))-->
<!--            </if>-->
            AND d.FAULT_FLAG!='2' AND d.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        </trim>
        ORDER BY d.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>

    <select id="getByIds" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        SELECT
        d.REC_ID AS "faultInfoRecId",
        df.REC_ID AS "faultOrderRecId",
        df.WORK_CLASS AS "workClass",
        d.COMPANY_CODE AS "companyCode",
        d.COMPANY_NAME AS "companyName",
        d.FAULT_NO AS "faultNo",
        d.FAULT_FLAG AS "faultFlag",
        d.OBJECT_CODE AS "objectCode",
        d.OBJECT_CODE AS "objectCode_textField",
        d.OBJECT_NAME AS "objectName",
        d.TRAIN_TRUNK AS "trainTrunk",
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line')
        AS
        "lineName",
        d.LINE_CODE AS "lineCode",
        d.POSITION_CODE AS "positionCode",
        d.POSITION2_CODE AS "position2Code",
        d.PART_CODE AS "partCode",
        d.PART_NAME AS "partName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS "majorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS "systemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS "equipTypeName",
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS "stationCode",
        (select u.NAME from SYS_USER u where u.LOGIN_NAME=trim(df.REPORT_FINISH_USER_ID)) as "reportFinishUserName",
        d.MAJOR_CODE AS "majorCode",
        d.SYSTEM_CODE AS "systemCode",
        d.EQUIP_TYPE_CODE AS "equipTypeCode",
        d.FAULT_MODULE AS "faultModule",
        d.FAULT_MODULE_ID AS "faultModuleId",
        d.FAULT_TYPE AS "faultType",
        d.SOURCE_CODE AS "sourceCode",
        d.FAULT_DISPLAY_CODE AS "faultDisplayCode",
        d.FAULT_DISPLAY_DETAIL AS "faultDisplayDetail",
        d.FAULT_DETAIL AS "faultDetail",
        d.DISCOVERER_ID AS "discovererId",
        d.DISCOVERER_PHONE AS "discovererPhone",
        d.DISCOVERER_NAME AS "discovererName",
        d.DISCOVERY_TIME AS "discoveryTime",
        d.FILLIN_USER_ID AS "fillinUserId",
        d.FILLIN_DEPT_CODE AS "fillinDeptCode",
        d.FILLIN_TIME AS "fillinTime",
        d.RESP_DEPT_CODE AS "respDeptCode",
        d.ASSIST_DEPT_CODE AS "assistDeptCode",
        d.REPAIR_DEPT_CODE AS "repairDeptCode",
        d.PUBLISH_USER_ID AS "publishUserId",
        d.PUBLISH_TIME AS "publishTime",
        d.FAULT_LEVEL AS "faultLevel",
        d.FAULT_STATUS AS "faultStatus",
        d.WORK_FLOW_INST_ID AS "workFlowInstId",
        d.WORK_FLOW_INST_STATUS AS "workFlowInstStatus",
        d.DOC_ID AS "docId",
        d.REMARK AS "remark",
        d.REC_CREATOR AS "recCreator",
        d.REC_CREATE_TIME AS "recCreateTime",
        d.REC_REVISOR AS "recRevisor",
        d.REC_REVISE_TIME AS "recReviseTime",
        d.REC_DELETOR AS "recDeletor",
        d.REC_DELETE_TIME AS "recDeleteTime",
        d.DELETE_FLAG AS "deleteFlag",
        d.ARCHIVE_FLAG AS "archiveFlag",
        d.REC_STATUS AS "recStatus",
        d.EXT1 AS "ext1",
        d.EXT2 AS "ext2",
        d.EXT3 AS "affect",
        d.EXT4 AS "ext4",
        d.EXT5 AS "ext5",
        d.TRAIN_TAG AS "traintag",
        (case when d.FILLIN_USER_NAME is null then u.NAME else d.FILLIN_USER_NAME end) AS "fillinUserName",
        df.CLOSE_TIME AS "closeTime",
        (SELECT u1.NAME FROM SYS_USER u1 WHERE u1.LOGIN_NAME=df.CLOSE_USER_ID) AS "closeUserName",
        df.DEALER_UNIT AS "dealerUnit",
        df.FAULT_PROCESS_RESULT AS "faultProcessResult",
        df.DEALER_NUM AS "dealerNum",
        df.FAULT_WORK_NO AS "faultWorkNo",
        df.REC_ID AS "orderRecId",
        df.ORDER_STATUS AS "orderStatus",
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        df.EXT1 AS "levelfault"
        FROM T_FAULT_INFO d
        LEFT JOIN SYS_USER u ON d.FILLIN_USER_ID=u.LOGIN_NAME
        LEFT JOIN T_FAULT_ORDER df ON d.FAULT_NO=df.FAULT_NO
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="faultType!=null and faultType!=''">
                AND d.FAULT_TYPE=#{faultType}
            </if>
            <if test="positionCode!=null and positionCode!=''">
                AND d.POSITION_CODE=#{positionCode}
            </if>
            <if test="faultNo!=null and faultNo!=''">
                AND d.FAULT_NO=#{faultNo}
            </if>
            <if test="faultWorkNo!=null and faultWorkNo!=''">
                AND df.FAULT_WORK_NO =#{faultWorkNo}
            </if>
            <if test="orderStatus!=null and orderStatus!=''">
                AND df.ORDER_STATUS=#{orderStatus}
            </if>
            <if test="invalid!=null and 'true'.toString()==invalid.toString()">
                AND df.ORDER_STATUS='99'
            </if>
            <if test="lineCode!=null and lineCode!=''">
                AND d.LINE_CODE=#{lineCode}
            </if>
            <if test="objectCode!=null and objectCode!=''">
                AND d.OBJECT_CODE=#{objectCode}
            </if>
            <if test="objectName!=null and objectName!=''">
                AND d.OBJECT_NAME=#{objectName}
            </if>
            <if test="majorCode!=null and majorCode!=''">
                AND d.MAJOR_CODE=#{majorCode}
            </if>
            <if test="systemCode!=null and systemCode!=''">
                AND d.SYSTEM_CODE=#{systemCode}
            </if>
            <if test="equipTypeCode!=null and equipTypeCode!=''">
                AND d.EQUIP_TYPE_CODE=#{equipTypeCode}
            </if>
            <if test="faultDetail!=null and faultDetail!=''">
                AND d.FAULT_DETAIL LIKE '%' || #{faultDetail} || '%'
            </if>
            <if test="fillinTimeStart!=null and fillinTimeStart!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{fillinTimeStart}, 'yyyy-mm-dd hh24:mi:ss')
            </if>
            <if test="fillinTimeEnd!=null and fillinTimeEnd!=''">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{fillinTimeEnd}, 'yyyy-mm-dd hh24:mi:ss') + 1
            </if>
            <if test="levelfault!=null and levelfault!=''">
                AND df.EXT1=#{levelfault}
            </if>
<!--            <if test="listType==null">-->
<!--                AND (d.FILLIN_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and-->
<!--                d.RESP_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and-->
<!--                d.ASSIST_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and-->
<!--                d.REPAIR_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%'))-->
<!--            </if>-->
<!--            <if test="listType!=null">-->
<!--                AND (d.FILLIN_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or-->
<!--                d.RESP_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or-->
<!--                d.ASSIST_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or-->
<!--                d.REPAIR_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%'))-->
<!--            </if>-->
            <if test="ids!=null and ids.size()>0">
                AND d.REC_ID IN (
                <foreach collection="ids" index="index" item="id" separator=",">
                    #{id}
                </foreach>
               )
            </if>
            AND d.FAULT_FLAG!='2' AND d.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        </trim>
        ORDER BY d.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>
    <sql id="fault-export-sql">
        SELECT
        d.REC_ID AS "recId",
        df.REC_ID AS "workId",
        df.WORK_CLASS AS "workClass",
        d.COMPANY_CODE AS "companyCode",
        d.COMPANY_NAME AS "companyName",
        d.FAULT_NO AS "faultNo",
        d.FAULT_FLAG AS "faultFlag",
        d.OBJECT_CODE AS "objectCode",
        d.OBJECT_CODE AS "objectCode_textField",
        d.OBJECT_NAME AS "objectName",
        d.TRAIN_TRUNK AS "trainTrunk",
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line')
        AS
        "lineName",
        d.LINE_CODE AS "lineCode",
        d.POSITION_CODE AS "positionCode",
        d.POSITION2_CODE AS "position2Code",
        d.PART_CODE AS "partCode",
        d.PART_NAME AS "partName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName_textField",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS "majorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS "systemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS "equipTypeName",
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS "stationCode",
        d.MAJOR_CODE AS "majorCode",
        d.SYSTEM_CODE AS "systemCode",
        d.EQUIP_TYPE_CODE AS "equipTypeCode",
        d.FAULT_MODULE AS "faultModule",
        d.FAULT_MODULE_ID AS "faultModuleId",
        d.FAULT_TYPE AS "faultType",
        d.SOURCE_CODE AS "sourceCode",
        d.FAULT_DISPLAY_CODE AS "faultDisplayCode",
        d.FAULT_DISPLAY_DETAIL AS "faultDisplayDetail",
        d.FAULT_DETAIL AS "faultDetail",
        d.DISCOVERER_ID AS "discovererId",
        d.DISCOVERER_PHONE AS "discovererPhone",
        d.DISCOVERER_NAME AS "discovererName",
        d.DISCOVERY_TIME AS "discoveryTime",
        d.FILLIN_USER_ID AS "fillinUserId",
        d.FILLIN_DEPT_CODE AS "fillinDeptCode",
        d.FILLIN_TIME AS "fillinTime",
        d.RESP_DEPT_CODE AS "respDeptCode",
        d.ASSIST_DEPT_CODE AS "assistDeptCode",
        d.REPAIR_DEPT_CODE AS "repairDeptCode",
        d.PUBLISH_USER_ID AS "publishUserId",
        d.PUBLISH_TIME AS "publishTime",
        d.FAULT_LEVEL AS "faultLevel",
        d.FAULT_STATUS AS "faultStatus",
        d.WORK_FLOW_INST_ID AS "workFlowInstId",
        d.WORK_FLOW_INST_STATUS AS "workFlowInstStatus",
        d.DOC_ID AS "docId",
        d.REMARK AS "remark",
        d.REC_CREATOR AS "recCreator",
        d.REC_CREATE_TIME AS "recCreateTime",
        d.REC_REVISOR AS "recRevisor",
        d.REC_REVISE_TIME AS "recReviseTime",
        d.REC_DELETOR AS "recDeletor",
        d.REC_DELETE_TIME AS "recDeleteTime",
        d.DELETE_FLAG AS "deleteFlag",
        d.ARCHIVE_FLAG AS "archiveFlag",
        d.REC_STATUS AS "recStatus",
        d.EXT1 AS "ext1",
        d.EXT2 AS "ext2",
        d.EXT3 AS "affect",
        d.EXT4 AS "ext4",
        d.EXT5 AS "ext5",
        d.TRAIN_TAG AS "traintag",
        (case when d.FILLIN_USER_NAME is null then u.NAME else d.FILLIN_USER_NAME end) AS "fillinUserName",
        df.CLOSE_TIME AS "closeTime",
        (SELECT u1.NAME FROM SYS_USER u1 WHERE u1.LOGIN_NAME=df.CLOSE_USER_ID) AS "closeUserName",
        df.DEALER_UNIT AS "dealerUnit",
        df.DEALER_NUM AS "dealerNum",
        df.FAULT_WORK_NO AS "faultWorkNo",
        df.REC_ID AS "orderRecId",
        df.ORDER_STATUS AS "orderStatus",
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        df.EXT1 AS "levelfault"
        FROM T_FAULT_INFO d
        LEFT JOIN SYS_USER u ON d.FILLIN_USER_ID=u.LOGIN_NAME
        LEFT JOIN T_FAULT_ORDER df ON d.FAULT_NO=df.FAULT_NO
        WHERE d.FAULT_FLAG!='2' AND d.DELETE_FLAG='0'
        <if test="req.faultType!=null">
            AND d.FAULT_TYPE=#{req.faultType}
        </if>
        <if test="req.positionCode!=null">
            AND d.POSITION_CODE=#{req.positionCode}
        </if>
        <if test="req.levelfault!=null">
            AND df.EXT1=#{req.levelfault}
        </if>
        <if test="req.faultNo!=null">
            AND d.FAULT_NO LIKE '%' || #{req.faultNo} || '%'
        </if>
        <if test="req.faultWorkNo!=null">
            AND df.FAULT_WORK_NO LIKE '%' || #{req.faultWorkNo} || '%'
        </if>
        <if test="req.orderStatus!=null and req.orderStatus!=''">
            AND df.ORDER_STATUS=#{req.orderStatus}
        </if>
        <if test="req.recStatus!=null and req.recStatus!=''">
            AND df.ORDER_STATUS!=#{req.recStatus}
        </if>
        <if test="req.objectCode!=null">
            AND d.OBJECT_CODE=#{req.objectCode}
        </if>
        <if test="req.objectName!=null">
            AND d.OBJECT_NAME=#{req.objectName}
        </if>
        <if test="req.majorCode!=null and req.majorCode!=''">
            AND d.MAJOR_CODE=#{req.majorCode}
        </if>
        <if test="req.systemCode!=null and req.systemCode!=''">
            AND d.SYSTEM_CODE=#{req.systemCode}
        </if>
        <if test="req.equipTypeCode!=null and req.equipTypeCode!=''">
            AND d.EQUIP_TYPE_CODE=#{req.equipTypeCode}
        </if>
        <if test="req.faultDetail!=null">
            AND d.FAULT_DETAIL LIKE '%' || #{req.faultDetail} || '%'
        </if>
        <if test="req.fillinTimeStart!=null">
            AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{req.fillinTimeStart}, 'YYYY-MM-DD
            HH24:MI:SS')
        </if>
        <if test="req.fillinTimeEnd!=null">
            AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{req.fillinTimeEnd}, 'YYYY-MM-DD
            HH24:MI:SS') + 1
        </if>
        <if test="req.typeCode!=null and req.typeCode!=''">
            AND df.FAULT_PROCESS_RESULT=#{req.typeCode}
        </if>
        <if test="req.faultNos!=null and req.faultNos.size() > 0">
            AND d.FAULT_NO IN
            <foreach collection="req.faultNos" item="code" open="(" close=")" separator=",">
                #{code}
            </foreach>
        </if>
        <if test="req.levelfault!=null and req.levelfault!=''">
            AND df.EXT1=#{req.levelfault}
        </if>
    </sql>
    <select id="list" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        <include refid="fault-export-sql"/>
        ORDER BY df.ORDER_STATUS asc, d.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>
    <select id="listExcludeZtt" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        <include refid="fault-export-sql"/>
        AND (d.FILLIN_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and
        d.RESP_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and
        d.ASSIST_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') and
        d.REPAIR_DEPT_CODE NOT IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%'))
        ORDER BY df.ORDER_STATUS asc, d.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>
    <select id="listZtt" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        <include refid="fault-export-sql"/>
        AND (d.FILLIN_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or
        d.RESP_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or
        d.ASSIST_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%') or
        d.REPAIR_DEPT_CODE IN (SELECT AREA_ID FROM SYS_OFFICE WHERE NAMES LIKE '%中铁通轨道运营有限公司%'))
        ORDER BY df.ORDER_STATUS asc, d.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>
    <select id="queryOrderStatus" resultType="java.lang.String">
        select
        df2.ORDER_STATUS
        from T_FAULT_INFO df1
        left join T_FAULT_ORDER df2 on df1.FAULT_NO=df2.FAULT_NO
        where 1=1
        <if test="reqDTO.id!=null">
            AND df2.FAULT_WORK_NO=#{reqDTO.id}
        </if>
    </select>
    <select id="construction" resultType="com.wzmtr.eam.dto.res.fault.ConstructionResDTO">
        SELECT
        REC_ID AS "recId",  <!-- 记录编号 -->
        SYSCODE AS "syscode",  <!-- 系统编码 -->
        OPER_TYPE AS "operType",  <!-- 操作类型 -->
        WORKPN AS "workpn",  <!-- 施工计划代码 -->
        WORKNO AS "workNo",  <!-- 工单号 -->
        WORKORDER AS "workorder",  <!-- 工单类型 -->
        PLANTIME AS "plantime",  <!-- 提报批准时间 -->
        CIRCULARTIME AS "circulartime",  <!-- 通告时间 -->
        PLANWORKER AS "planworker",  <!-- 提报人 -->
        CONSTLEADER AS "constleader",  <!-- 施工负责人 -->
        REMARK AS "remark",  <!-- 备注 -->
        REC_CREATOR AS "recCreator",  <!-- 创建者 -->
        REC_CREATE_TIME AS "recCreateTime",  <!-- 创建时间 -->
        REC_REVISOR AS "recRevisor",  <!-- 修改者 -->
        REC_REVISE_TIME AS "recReviseTime",  <!-- 修改时间 -->
        REC_DELETOR AS "recDeletor",  <!-- 删除者 -->
        REC_DELETE_TIME AS "recDeleteTime",  <!-- 删除时间 -->
        DELETE_FLAG AS "deleteFlag",  <!-- 删除标志 -->
        ARCHIVE_FLAG AS "archiveFlag",  <!-- 归档标记 -->
        REC_STATUS AS "recStatus",  <!-- 记录状态 -->
        EXT1 AS "ext1",  <!-- 扩展字段1 -->
        EXT2 AS "ext2",  <!-- 扩展字段2 -->
        EXT3 AS "ext3",  <!-- 扩展字段3 -->
        EXT4 AS "ext4",  <!-- 扩展字段4 -->
        EXT5 AS "ext5"  <!-- 扩展字段5 -->
        FROM T_WORK_PLAN
        WHERE 1=1
        <if test="faultWorkNo!=null">
            AND WORKNO=#{faultWorkNo}
        </if>
        ORDER BY REC_ID ASC
    </select>

    <select id="cancellation" resultType="com.wzmtr.eam.dto.res.fault.ConstructionResDTO">
        SELECT
        REC_ID as "recId",  <!-- 记录编号 -->
        SYSCODE as "syscode",  <!-- 系统编码 -->
        OPER_TYPE as "operType",  <!-- 操作类型 -->
        WORKPN as "workpn",  <!-- 施工计划代码 -->
        WORKNO as "workno",  <!-- 检修工单号 -->
        WORKORDER as "workorder",  <!-- 工单类型 -->
        APPLYTIME as "applytime",  <!-- 请点批准时间 -->
        DELAYTIME as "delaytime",  <!-- 销点批准时间 -->
        CONSTLEADER as "constleader",  <!-- 施工负责人 -->
        WORKERSUM as "workersum",  <!-- 施工人数 -->
        DEVICESUM as "devicesum",  <!-- 携带工器具数量 -->
        MASTERAPPSTAITON as "masterappstaiton",  <!-- 请点主站 -->
        MASTERDELSTAITON as "masterdelstaiton",  <!-- 销点主站 -->
        MASTERSTAITON as "masterstaiton",  <!-- 辅站 -->
        FINISHSTATUS as "finishstatus",  <!-- 是否完成 -->
        REMARK as "remark",  <!-- 完成情况 -->
        REASON as "reason",  <!-- 未完成原因 -->
        REMARKS as "remarks",  <!-- 备注 -->
        REC_CREATOR as "recCreator",  <!-- 创建者 -->
        REC_CREATE_TIME as "recCreateTime",  <!-- 创建时间 -->
        REC_REVISOR as "recRevisor",  <!-- 修改者 -->
        REC_REVISE_TIME as "recReviseTime",  <!-- 修改时间 -->
        REC_DELETOR as "recDeletor",  <!-- 删除者 -->
        REC_DELETE_TIME as "recDeleteTime",  <!-- 删除时间 -->
        DELETE_FLAG as "deleteFlag",  <!-- 删除标志 -->
        ARCHIVE_FLAG as "archiveFlag",  <!-- 归档标记 -->
        REC_STATUS as "recStatus",  <!-- 记录状态 -->
        EXT1 as "ext1",  <!-- 扩展字段1 -->
        EXT2 as "ext2",  <!-- 扩展字段2 -->
        EXT3 as "ext3",  <!-- 扩展字段3 -->
        EXT4 as "ext4",  <!-- 扩展字段4 -->
        EXT5 as "ext5" <!-- 扩展字段5 -->
        FROM T_REQUEST_POINTS WHERE 1=1
        <if test="faultWorkNo!=null">
            AND WORKNO=#{faultWorkNo}
        </if>
        order by REC_ID asc
    </select>
    <select id="export" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        SELECT
        d.REC_ID AS faultInfoRecId,
        df.REC_ID AS faultOrderRecId,
        df.WORK_CLASS AS workClass,
        d.COMPANY_CODE AS companyCode,
        d.COMPANY_NAME AS companyName,
        d.FAULT_NO AS faultNo,
        d.FAULT_FLAG AS faultFlag,
        d.OBJECT_CODE AS objectCode,
        d.OBJECT_CODE AS objectCode_textField,
        d.OBJECT_NAME AS objectName,
        d.TRAIN_TRUNK AS trainTrunk,
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line') AS lineName,
        d.LINE_CODE AS lineCode,
        d.POSITION_CODE AS positionCode,
        d.POSITION2_CODE AS position2Code,
        d.PART_CODE AS partCode,
        d.PART_NAME AS partName,
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS positionName_textField,
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS positionName,
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS majorName,
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS systemName,
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS equipTypeName,
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS stationCode,
        d.MAJOR_CODE AS majorCode,
        d.SYSTEM_CODE AS systemCode,
        d.EQUIP_TYPE_CODE AS equipTypeCode,
        d.FAULT_MODULE AS faultModule,
        d.FAULT_MODULE_ID AS faultModuleId,
        d.FAULT_TYPE AS faultType,
        d.SOURCE_CODE AS sourceCode,
        d.FAULT_DISPLAY_CODE AS faultDisplayCode,
        d.FAULT_DISPLAY_DETAIL AS faultDisplayDetail,
        d.FAULT_DETAIL AS faultDetail,
        d.DISCOVERER_ID AS discovererId,
        d.DISCOVERER_PHONE AS discovererPhone,
        d.DISCOVERER_NAME AS discovererName,
        d.DISCOVERY_TIME AS discoveryTime,
        d.FILLIN_USER_ID AS fillinUserId,
        d.FILLIN_DEPT_CODE AS fillinDeptCode,
        d.FILLIN_TIME AS fillinTime,
        d.RESP_DEPT_CODE AS respDeptCode,
        d.ASSIST_DEPT_CODE AS assistDeptCode,
        d.REPAIR_DEPT_CODE AS repairDeptCode,
        d.PUBLISH_USER_ID AS publishUserId,
        d.PUBLISH_TIME AS publishTime,
        d.FAULT_LEVEL AS faultLevel,
        d.FAULT_STATUS AS faultStatus,
        d.WORK_FLOW_INST_ID AS workFlowInstId,
        d.WORK_FLOW_INST_STATUS AS workFlowInstStatus,
        d.DOC_ID AS docId,
        d.REMARK AS remark,
        d.REC_CREATOR AS recCreator,
        d.REC_CREATE_TIME AS recCreateTime,
        d.REC_REVISOR AS recRevisor,
        d.REC_REVISE_TIME AS recReviseTime,
        d.REC_DELETOR AS recDeletor,
        d.REC_DELETE_TIME AS recDeleteTime,
        d.DELETE_FLAG AS deleteFlag,
        d.ARCHIVE_FLAG AS archiveFlag,
        d.REC_STATUS AS recStatus,
        d.EXT1 AS ext1,
        d.EXT2 AS ext2,
        d.EXT3 AS affect,
        d.EXT4 AS ext4,
        d.EXT5 AS ext5,
        d.TRAIN_TAG AS traintag,
        (case when d.FILLIN_USER_NAME is null then u.NAME else d.FILLIN_USER_NAME end) AS fillinUserName,
        df.CLOSE_TIME AS closeTime,
        (SELECT u1.NAME FROM SYS_USER u1 WHERE u1.LOGIN_NAME=df.CLOSE_USER_ID) AS closeUserName,
        df.DEALER_UNIT AS dealerUnit,
        df.DEALER_NUM AS dealerNum,
        (SELECT NAME FROM SYS_USER WHERE LOGIN_NAME=df.REPAIR_RESP_USER_ID) as repairRespUserName,
        df.FAULT_WORK_NO AS faultWorkNo,
        df.REC_ID AS orderRecId,
        df.ORDER_STATUS AS orderStatus,
        df.EXT1 AS levelfault,
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        (CASE WHEN TO_DATE(d.FILLIN_TIME, 'yyyy-mm-dd hh24:mi:ss') <![CDATA[<]]> TO_DATE(SYSDATE - 20) AND
        (df.ORDER_STATUS='10' OR df.ORDER_STATUS='20' OR df.ORDER_STATUS='30') AND
        df.ORDER_STATUS!='99' AND df.ORDER_STATUS!='60' AND df.ORDER_STATUS!='70' THEN 1
        WHEN TO_DATE(d.FILLIN_TIME, 'yyyy-mm-dd hh24:mi:ss') <![CDATA[>=]]> TO_DATE(SYSDATE - 20) AND
        TO_DATE(d.FILLIN_TIME, 'yyyy-mm-dd hh24:mi:ss') <![CDATA[<=]]> TO_DATE(SYSDATE - 10) AND
        (df.ORDER_STATUS='10' OR df.ORDER_STATUS='20' OR df.ORDER_STATUS='30') AND
        df.ORDER_STATUS!='99' AND df.ORDER_STATUS!='60' AND df.ORDER_STATUS!='70' THEN 2
        WHEN TO_DATE(d.FILLIN_TIME, 'yyyy-mm-dd hh24:mi:ss') <![CDATA[>=]]> TO_DATE(SYSDATE - 10) AND
        (df.ORDER_STATUS='10' OR df.ORDER_STATUS='20' OR df.ORDER_STATUS='30') AND
        df.ORDER_STATUS!='99' AND df.ORDER_STATUS!='60' AND df.ORDER_STATUS!='70' THEN 3
        ELSE 9 END) AS sort,
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=df.FINISH_MAJOR_CODE) AS "finishMajorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=df.FINISH_SYSTEM_CODE) AS "finishSystemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=df.FINISH_EQUIP_TYPE_CODE) AS "finishEquipTypeName",
        df.FINISH_MAJOR_CODE AS "finishMajorCode",
        df.FINISH_SYSTEM_CODE AS "finishSystemCode",
        df.FINISH_EQUIP_TYPE_CODE AS "finishEquipTypeCode",
        df.FINISH_OBJECT_CODE AS "finishObjectCode",
        df.FINISH_OBJECT_NAME AS "finishObjectName",
        df.FINISH_POSITION_CODE AS "finishPositionCode",
        df.FINISH_POSITION2_CODE AS "finishPosition2Code",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=df.FINISH_POSITION_CODE) AS "finishPositionName",
        df.FINISH_PART_ID AS "finishPartId"
        FROM T_FAULT_INFO d
        LEFT JOIN SYS_USER u ON d.FILLIN_USER_ID=u.LOGIN_NAME
        LEFT JOIN T_FAULT_ORDER df ON d.FAULT_NO=df.FAULT_NO AND d.FAULT_FLAG!='2'
        WHERE 1=1 AND d.DELETE_FLAG='0' AND df.ORDER_STATUS!='0'
        <if test="faultType!=null">
            AND d.FAULT_TYPE=#{faultType}
        </if>
        <if test="positionCode!=null">
            AND d.POSITION_CODE=#{positionCode}
        </if>
        <if test="orderStatus!=null">
            AND df.ORDER_STATUS=#{orderStatus}
        </if>
        <if test="objectCode!=null">
            AND d.OBJECT_CODE=#{objectCode}
        </if>
        <if test="objectName!=null">
            AND d.OBJECT_NAME=#{objectName}
        </if>
        <if test="majorCode!=null">
            AND d.MAJOR_CODE=#{majorCode}
        </if>
        <if test="systemCode!=null">
            AND d.SYSTEM_CODE=#{systemCode}
        </if>
        <if test="equipTypeCode!=null">
            AND d.EQUIP_TYPE_CODE=#{equipTypeCode}
        </if>
        <if test="faultDetail!=null">
            AND d.FAULT_DETAIL LIKE '%' || #{faultDetail} || '%'
        </if>
        <if test="fillinTimeStart!=null">
            AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{fillinTimeStart}, 'YYYY-MM-DD')
        </if>
        <if test="fillinTimeEnd!=null">
            AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{fillinTimeEnd}, 'YYYY-MM-DD') + 1
        </if>
        <if test="faultNos!=null and faultNos.size() > 0">
            AND d.FAULT_NO IN
            <foreach collection="faultNos" item="code" open="(" close=")" separator=",">
                #{code}
            </foreach>
        </if>
        <if test="faultWorkNos!=null and faultWorkNos.size() > 0">
            AND df.FAULT_WORK_NO IN
            <foreach collection="faultWorkNos" item="code" open="(" close=")" separator=",">
                #{code}
            </foreach>
        </if>
        ORDER BY sort, df.ORDER_STATUS ASC, d.FAULT_NO DESC, df.FAULT_WORK_NO DESC
    </select>
    <select id="queryOneFaultInfo" resultType="com.wzmtr.eam.dataobject.FaultInfoDO">
        SELECT
        d.REC_ID AS "recId",
        d.COMPANY_CODE AS "companyCode",
        d.COMPANY_NAME AS "companyName",
        d.FAULT_NO AS "faultNo",
        d.FAULT_FLAG AS "faultFlag",
        d.OBJECT_CODE AS "objectCode",
        d.OBJECT_CODE AS "objectCode_textField",
        d.OBJECT_NAME AS "objectName",
        d.TRAIN_TRUNK AS "trainTrunk",
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line')
        AS
        "lineName",
        d.LINE_CODE AS "lineCode",
        d.POSITION_CODE AS "positionCode",
        d.POSITION2_CODE AS "position2Code",
        d.PART_CODE AS "partCode",
        d.PART_NAME AS "partName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName_textField",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION2_CODE) AS "position2Name",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS "majorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS "systemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS "equipTypeName",
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS "stationCode",
        d.MAJOR_CODE AS "majorCode",
        d.SYSTEM_CODE AS "systemCode",
        d.EQUIP_TYPE_CODE AS "equipTypeCode",
        d.FAULT_MODULE AS "faultModule",
        d.FAULT_MODULE_ID AS "faultModuleId",
        d.FAULT_TYPE AS "faultType",
        d.SOURCE_CODE AS "sourceCode",
        d.FAULT_DISPLAY_CODE AS "faultDisplayCode",
        d.FAULT_DISPLAY_DETAIL AS "faultDisplayDetail",
        d.FAULT_DETAIL AS "faultDetail",
        d.DISCOVERER_ID AS "discovererId",
        d.DISCOVERER_PHONE AS "discovererPhone",
        d.DISCOVERER_NAME AS "discovererName",
        d.DISCOVERY_TIME AS "discoveryTime",
        d.FILLIN_USER_ID AS "fillinUserId",
        d.FILLIN_DEPT_CODE AS "fillinDeptCode",
        d.FILLIN_TIME AS "fillinTime",
        d.RESP_DEPT_CODE AS "respDeptCode",
        d.ASSIST_DEPT_CODE AS "assistDeptCode",
        d.REPAIR_DEPT_CODE AS "repairDeptCode",
        d.PUBLISH_USER_ID AS "publishUserId",
        d.PUBLISH_TIME AS "publishTime",
        d.FAULT_LEVEL AS "faultLevel",
        d.FAULT_STATUS AS "faultStatus",
        d.WORK_FLOW_INST_ID AS "workFlowInstId",
        d.WORK_FLOW_INST_STATUS AS "workFlowInstStatus",
        d.DOC_ID AS "docId",
        d.REMARK AS "remark",
        d.REC_CREATOR AS "recCreator",
        d.REC_CREATE_TIME AS "recCreateTime",
        d.REC_REVISOR AS "recRevisor",
        d.REC_REVISE_TIME AS "recReviseTime",
        d.REC_DELETOR AS "recDeletor",
        d.REC_DELETE_TIME AS "recDeleteTime",
        d.DELETE_FLAG AS "deleteFlag",
        d.ARCHIVE_FLAG AS "archiveFlag",
        d.REC_STATUS AS "recStatus",
        d.EXT1 AS "ext1",
        d.EXT2 AS "ext2",
        d.EXT3 AS "affect",
        d.EXT4 AS "ext4",
        d.EXT5 AS "ext5",
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        d.TRAIN_TAG AS "traintag"
        FROM T_FAULT_INFO d
        LEFT JOIN T_FAULT_ORDER df on d.FAULT_NO=df.FAULT_NO
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="faultWorkNo!=null and faultWorkNo!=''">
                AND df.FAULT_WORK_NO LIKE '%' || #{faultWorkNo} || '%'
            </if>
            <if test="faultNo!=null and faultNo!=''">
                AND d.FAULT_NO LIKE '%' || #{faultNo} || '%'
            </if>
        </trim>
    </select>
    <select id="queryOneFaultOrder" resultType="com.wzmtr.eam.dataobject.FaultOrderDO">
        SELECT * FROM (
        SELECT
        REC_ID as "recId",
        COMPANY_CODE as "companyCode",
        COMPANY_NAME as "companyName",
        FAULT_NO as "faultNo",
        FAULT_WORK_NO as "faultWorkNo",
        DISPATCH_USER_ID as "dispatchUserId",
        DISPATCH_TIME as "dispatchTime",
        REPAIR_RESP_USER_ID as "repairRespUserId",
        WORK_AREA as "workArea",
        ORDER_STATUS as "orderStatus",
        REPAIR_DISPATCH_NO as "repairDispatchNo",
        REPORT_USER_ID as "reportUserId",
        REPORT_TIME as "reportTime",
        WORK_CLASS as "workClass",
        CHECK_USER_ID as "checkUserId",
        CHECK_TIME as "checkTime",
        RUSH_REPAIR_NO as "rushRepairNo",
        ARRIVAL_TIME as "arrivalTime",
        REPAIR_START_TIME as "repairStartTime",
        REPAIR_END_TIME as "repairEndTime",
        REPAIR_TIME as "repairTime",
        LEAVE_TIME as "leaveTime",
        FAULT_REASON_CODE as "faultReasonCode",
        FAULT_REASON_DETAIL as "faultReasonDetail",
        FAULT_ACTION_CODE as "faultActionCode",
        FAULT_ACTION_DETAIL as "faultActionDetail",
        FAULT_PROCESS_RESULT as "faultProcessResult",
        REPORT_START_USER_ID as "reportStartUserId",
        REPORT_START_TIME as "reportStartTime",
        REPORT_FINISH_USER_ID as "reportFinishUserId",
        REPORT_FINISH_TIME as "reportFinishTime",
        CONFIRM_USER_ID as "confirmUserId",
        CONFIRM_TIME as "confirmTime",
        CLOSE_USER_ID as "closeUserId",
        CLOSE_TIME as "closeTime",
        WORK_FLOW_INST_ID as "workFlowInstId",
        WORK_FLOW_INST_STATUS as "workFlowInstStatus",
        PLAN_RECOVERY_TIME as "planRecoveryTime",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(DISPATCH_USER_ID)) as "dispatchUserName",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(REPAIR_RESP_USER_ID)) as "repairRespUserName",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(CHECK_USER_ID)) as "checkUserName",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(CLOSE_USER_ID)) as "closeUserName",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(REPORT_FINISH_USER_ID)) as "reportFinishUserName",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(CONFIRM_USER_ID)) as "confirmUserName",
        (SELECT u.NAME FROM SYS_USER u WHERE u.LOGIN_NAME=TRIM(REPORT_USER_ID)) as "reportUserName",
        FAULT_AFFECT as "faultAffect",
        IS_DETAINING_REPAIR as "isDetainingRepair",
        DOC_ID as "docId",
        REMARK as "remark",
        REC_CREATOR as "recCreator",
        REC_CREATE_TIME as "recCreateTime",
        REC_REVISOR as "recRevisor",
        REC_REVISE_TIME as "recReviseTime",
        REC_DELETOR as "recDeletor",
        REC_DELETE_TIME as "recDeleteTime",
        DELETE_FLAG as "deleteFlag",
        ARCHIVE_FLAG as "archiveFlag",
        REC_STATUS as "recStatus",
        EXT1 as "levelfault",
        EXT2 as "ext2",
        EXT3 as "ext3",
        EXT4 as "ext4",
        EXT5 as "ext5"
        FROM T_FAULT_ORDER
        WHERE 1=1
        <if test="faultWorkNo!=null and faultWorkNo!=''">
            AND FAULT_WORK_NO=#{faultWorkNo}
        </if>
        <if test="faultNo!=null and faultNo!=''">
            AND FAULT_NO=#{faultNo}
        </if>
        ORDER BY FAULT_WORK_NO DESC)
        WHERE rownum=1
    </select>
    <select id="queryDetail" resultType="com.wzmtr.eam.dto.res.fault.FaultDetailResDTO">
        SELECT
        d.REC_ID AS "recId",
        df.REC_ID AS "workId",
        df.WORK_CLASS AS "workClass",
        d.COMPANY_CODE AS "companyCode",
        d.COMPANY_NAME AS "companyName",
        d.FAULT_NO AS "faultNo",
        d.FAULT_FLAG AS "faultFlag",
        d.OBJECT_CODE AS "objectCode",
        d.OBJECT_CODE AS "objectCode_textField",
        d.OBJECT_NAME AS "objectName",
        d.TRAIN_TRUNK AS "trainTrunk",
        (SELECT ec.ITEM_CNAME FROM SYS_DICT ec WHERE ec.ITEM_CODE=d.LINE_CODE AND ec.CODESET_CODE='line')
        AS
        "lineName",
        d.LINE_CODE AS "lineCode",
        d.POSITION_CODE AS "positionCode",
        d.POSITION2_CODE AS "position2Code",
        d.PART_CODE AS "partCode",
        d.PART_NAME AS "partName",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName_textField",
        (SELECT db.NODE_NAME FROM SYS_REGION db WHERE db.NODE_CODE=d.POSITION_CODE) AS "positionName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.MAJOR_CODE) AS "majorName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.SYSTEM_CODE) AS "systemName",
        (SELECT db.NODE_NAME FROM T_EQUIPMENT_CATEGORY db WHERE db.NODE_CODE=d.EQUIP_TYPE_CODE) AS "equipTypeName",
        (SELECT d3.NODE_NAME FROM SYS_REGION d3 WHERE d3.NODE_CODE=d.EXT1) AS "stationCode",
        d.MAJOR_CODE AS "majorCode",
        d.SYSTEM_CODE AS "systemCode",
        d.EQUIP_TYPE_CODE AS "equipTypeCode",
        d.FAULT_MODULE AS "faultModule",
        d.FAULT_MODULE_ID AS "faultModuleId",
        d.FAULT_TYPE AS "faultType",
        d.SOURCE_CODE AS "sourceCode",
        d.FAULT_DISPLAY_CODE AS "faultDisplayCode",
        d.FAULT_DISPLAY_DETAIL AS "faultDisplayDetail",
        d.FAULT_DETAIL AS "faultDetail",
        d.DISCOVERER_ID AS "discovererId",
        d.DISCOVERER_PHONE AS "discovererPhone",
        d.DISCOVERER_NAME AS "discovererName",
        d.DISCOVERY_TIME AS "discoveryTime",
        d.FILLIN_USER_ID AS "fillinUserId",
        d.FILLIN_DEPT_CODE AS "fillinDeptCode",
        d.FILLIN_TIME AS "fillinTime",
        d.RESP_DEPT_CODE AS "respDeptCode",
        d.ASSIST_DEPT_CODE AS "assistDeptCode",
        d.REPAIR_DEPT_CODE AS "repairDeptCode",
        d.PUBLISH_USER_ID AS "publishUserId",
        d.PUBLISH_TIME AS "publishTime",
        d.FAULT_LEVEL AS "faultLevel",
        d.FAULT_STATUS AS "faultStatus",
        d.WORK_FLOW_INST_ID AS "workFlowInstId",
        d.WORK_FLOW_INST_STATUS AS "workFlowInstStatus",
        d.DOC_ID AS "docId",
        d.REMARK AS "remark",
        d.REC_CREATOR AS "recCreator",
        d.REC_CREATE_TIME AS "recCreateTime",
        d.REC_REVISOR AS "recRevisor",
        d.REC_REVISE_TIME AS "recReviseTime",
        d.REC_DELETOR AS "recDeletor",
        d.REC_DELETE_TIME AS "recDeleteTime",
        d.DELETE_FLAG AS "deleteFlag",
        d.ARCHIVE_FLAG AS "archiveFlag",
        d.REC_STATUS AS "recStatus",
        d.EXT1 AS "ext1",
        d.EXT2 AS "ext2",
        d.EXT3 AS "affect",
        d.EXT4 AS "ext4",
        d.EXT5 AS "ext5",
        d.TRAIN_TAG AS "traintag",
        (case when d.FILLIN_USER_NAME is null then u.NAME else d.FILLIN_USER_NAME end) AS "fillinUserName",
        df.CLOSE_TIME AS "closeTime",
        (SELECT u1.NAME FROM SYS_USER u1 WHERE u1.LOGIN_NAME=df.CLOSE_USER_ID) AS "closeUserName",
        df.DEALER_UNIT AS "dealerUnit",
        df.DEALER_NUM AS "dealerNum",
        df.FAULT_WORK_NO AS "faultWorkNo",
        df.REC_ID AS "orderRecId",
        df.ORDER_STATUS AS "orderStatus",
        d.IF_PHM AS "ifPhm",
        d.IF_RELIABILITY AS "ifReliability",
        d.IF_OTHER AS "ifOther",
        df.EXT1 AS "levelfault"
        FROM T_FAULT_INFO d
        LEFT JOIN SYS_USER u ON d.FILLIN_USER_ID=u.LOGIN_NAME
        LEFT JOIN T_FAULT_ORDER df ON d.FAULT_NO=df.FAULT_NO
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="req.faultType!=null">
                AND d.FAULT_TYPE=#{req.faultType}
            </if>
            <if test="req.positionCode!=null">
                AND d.POSITION_CODE=#{req.positionCode}
            </if>
            <if test="req.faultNo!=null">
                AND d.FAULT_NO LIKE '%' || #{req.faultNo} || '%'
            </if>
            <if test="req.faultWorkNo!=null">
                AND df.FAULT_WORK_NO LIKE '%' || #{req.faultWorkNo} || '%'
            </if>
            <if test="req.orderStatus!=null and req.orderStatus!=''">
                AND df.ORDER_STATUS=#{req.orderStatus}
            </if>
            <if test="req.recStatus!=null and req.recStatus!=''">
                AND df.ORDER_STATUS!=#{req.recStatus}
            </if>
            <if test="req.objectCode!=null">
                AND d.OBJECT_CODE=#{req.objectCode}
            </if>
            <if test="req.objectName!=null">
                AND d.OBJECT_NAME=#{req.objectName}
            </if>
            <if test="req.majorCode!=null">
                AND d.MAJOR_CODE=#{req.majorCode}
            </if>
            <if test="req.systemCode!=null and req.systemCode!=''">
                AND d.SYSTEM_CODE=#{req.systemCode}
            </if>
            <if test="req.equipTypeCode!=null and req.equipTypeCode!=''">
                AND d.EQUIP_TYPE_CODE=#{req.equipTypeCode}
            </if>
            <if test="req.faultDetail!=null">
                AND d.FAULT_DETAIL LIKE '%' || #{req.faultDetail} || '%'
            </if>
            <if test="req.fillinTimeStart!=null">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &gt;= to_date(#{req.fillinTimeStart}, 'YYYY-MM-DD')
            </if>
            <if test="req.fillinTimeEnd!=null">
                AND to_date(d.FILLIN_TIME, 'YYYY-MM-DD HH24:MI:SS') &lt;= to_date(#{req.fillinTimeEnd}, 'YYYY-MM-DD') + 1
            </if>
            AND d.FAULT_FLAG!='2'
        </trim>
        ORDER BY df.ORDER_STATUS asc, d.FAULT_NO desc,df.FAULT_WORK_NO desc
    </select>
    <select id="queryDeptCode" resultType="com.wzmtr.eam.dto.res.basic.FaultRepairDeptResDTO">
        SELECT DISTINCT T05.ORG_CODE as "orgCode",
        o.NAME as "orgName"
        FROM SYS_ORG_MAJOR T05
        LEFT JOIN SYS_ORG_LINE T06 ON T05.ORG_CODE=T06.ORG_CODE
        LEFT JOIN SYS_ORG_TYPE T07 ON T05.ORG_CODE=T07.ORG_CODE
        LEFT JOIN SYS_OFFICE o ON o.AREA_ID=T05.ORG_CODE AND o.DEL_FLAG='0'
        WHERE T05.DELETE_FLAG = '0' AND o.NAME IS NOT NULL
        <if test="majorCode!=null and majorCode!=''">
            AND T05.MAJOR_CODE=#{majorCode}
        </if>
        <if test="lineCode!=null and lineCode!=''">
            AND T06.LINE_CODE=#{lineCode}
        </if>
        <if test="orgType!=null and orgType!=''">
            AND T07.ORG_TYPE=#{orgType}
        </if>
        ORDER BY T05.ORG_CODE asc
    </select>

    <select id="getSubjectFaultNum" resultType="java.lang.Long">
        SELECT COUNT(*) FROM
        T_FAULT_INFO
        WHERE DELETE_FLAG='0'
        <if test="req.majorCodes!=null and req.majorCodes.size()>0">
            AND MAJOR_CODE IN (
            <foreach collection="req.majorCodes" index="index" item="majorCode" separator=",">
                #{majorCode}
            </foreach>
            )
        </if>
        <if test="req.systemCodes!=null and req.systemCodes.size()>0">
            AND SYSTEM_CODE IN (
            <foreach collection="req.systemCodes" index="index" item="systemCode" separator=",">
                #{systemCode}
            </foreach>
            )
        </if>
        <if test="req.equipTypeCodes!=null and req.equipTypeCodes.size()>0">
            AND EQUIP_TYPE_CODE IN (
            <foreach collection="req.equipTypeCodes" index="index" item="equipTypeCode" separator=",">
                #{equipTypeCode}
            </foreach>
            )
        </if>
        <if test="startTime!=null and startTime!=''">
            AND DISCOVERY_TIME>=#{startTime}
        </if>
        <if test="endTime!=null and endTime!=''">
            AND #{endTime}>=DISCOVERY_TIME
        </if>
    </select>
</mapper>
