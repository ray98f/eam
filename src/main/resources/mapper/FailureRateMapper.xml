<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wzmtr.eam.mapper.statistic.FailureRateMapper">


    <select id="exitingRate" resultType="com.wzmtr.eam.dto.res.statistic.FailureRateResDTO">
        select c.YEAR_MONTH as "yearMonth",
               round(
                           (select count(1) from T_FAULT_INFO a
                            where a.MAJOR_CODE='07'
                              and substr(a.DISCOVERY_TIME,1,7)=c.YEAR_MONTH
                              and rtrim(a.FAULT_FLAG) is null
                              and exists(select 1 from T_FAULT_ORDER b where b.FAULT_NO=a.FAULT_NO and b.ORDER_STATUS<![CDATA[ <>]]>'99'
                                                                          and b.EXT3 in('05', '06', '09'))
                           ) /
                           (select sum(t.MILES_INCREMENT)/10000 from T_TRAIN_MILEAGE t where substr(t.FILLIN_TIME,1,7)=c.YEAR_MONTH)
                   ,2) as "precent"
        from
            (
                select to_char(add_months(to_date(#{startTime}, 'YYYY-MM'), rownum - 1), 'YYYY-MM') as YEAR_MONTH
                from dual
                    connect by rownum <![CDATA[ <=]]> months_between(to_date(#{endTime}, 'YYYY-MM'), to_date(#{startTime}, 'YYYY-MM')) + 1
            ) c
        order by c.YEAR_MONTH
    </select>
    <select id="vehicleRate" resultType="com.wzmtr.eam.dto.res.statistic.FailureRateResDTO">
        select c.YEAR_MONTH as "yearMonth",
               round(
                           (select count(1)
                            from T_FAULT_INFO a
                            where a.MAJOR_CODE = '07'
                              and substr(a.DISCOVERY_TIME, 1, 7) = c.YEAR_MONTH
                              and rtrim(a.FAULT_FLAG) is null
                              and exists(select 1
                                         from T_FAULT_ORDER b
                                         where b.FAULT_NO = a.FAULT_NO
                                           and b.ORDER_STATUS<![CDATA[ <>]]> '99'
                                           and b.EXT3 in ('11', '02', '03', '04', '05', '06', '07', '08', '09', '10'))) /
                           (select sum(t.MILES_INCREMENT) / 10000
                            from T_TRAIN_MILEAGE t
                            where substr(t.FILLIN_TIME, 1, 7) = c.YEAR_MONTH)
                   , 2)     as "precent"
        from (select to_char(add_months(to_date(#{startTime}, 'YYYY-MM'), rownum - 1), 'YYYY-MM') as YEAR_MONTH
              from dual
                  connect by rownum <![CDATA[ <=]]> months_between(to_date(#{endTime}, 'YYYY-MM'), to_date(#{startTime}, 'YYYY-MM')) + 1) c
        order by c.YEAR_MONTH

    </select>
    <select id="signalRate" resultType="com.wzmtr.eam.dto.res.statistic.FailureRateResDTO">
        select c.YEAR_MONTH as "yearMonth",
               round((select count(1)
                      from T_FAULT_INFO a
                      where a.MAJOR_CODE = '09'
                        and substr(a.DISCOVERY_TIME, 1, 7) = c.YEAR_MONTH
                        and rtrim(a.FAULT_FLAG) is null
                        and a.EQUIP_TYPE_CODE in
                            ('090106', '090205', '090210', '090211', '090212', '090218', '090501', '090502',
                             '090503', '090504', '090505')
                        and exists(select 1
                                   from T_FAULT_ORDER b
                                   where b.FAULT_NO = a.FAULT_NO
                                     and b.ORDER_STATUS<![CDATA[ <>]]> '99')) /
                     (select sum(t.MILES_INCREMENT) / 10000
                      from T_TRAIN_MILEAGE t
                      where substr(t.FILLIN_TIME, 1, 7) = c.YEAR_MONTH)
                   , 2)     as "precent"
        from (select to_char(add_months(to_date(#{startTime}, 'YYYY-MM'), rownum - 1), 'YYYY-MM') as YEAR_MONTH
              from dual
                  connect by rownum <![CDATA[ <=]]> months_between(to_date(#{endTime}, 'YYYY-MM'), to_date(#{startTime}, 'YYYY-MM')) + 1) c
        order by c.YEAR_MONTH
    </select>
    <select id="powerRate" resultType="com.wzmtr.eam.dto.res.statistic.FailureRateResDTO">
        select c.YEAR_MONTH as "yearMonth",
               round(
                           (select count(1)
                            from T_FAULT_INFO a
                            where a.MAJOR_CODE in ('12', '13')
                              and substr(a.DISCOVERY_TIME, 1, 7) = c.YEAR_MONTH
                              and rtrim(a.FAULT_FLAG) is null
                              and exists(select 1
                                         from T_FAULT_ORDER b
                                         where b.FAULT_NO = a.FAULT_NO and b.ORDER_STATUS<![CDATA[ <>]]> '99')) /
                           (select sum(t.MILES_INCREMENT) / 10000
                            from T_TRAIN_MILEAGE t
                            where substr(t.FILLIN_TIME, 1, 7) = c.YEAR_MONTH)
                   , 2)     as "precent"
        from (select to_char(add_months(to_date(#{startTime}, 'YYYY-MM'), rownum - 1), 'YYYY-MM') as YEAR_MONTH
              from dual
                  connect by rownum <![CDATA[ <=]]> months_between(to_date(#{endTime}, 'YYYY-MM'), to_date(#{startTime}, 'YYYY-MM')) + 1) c
        order by c.YEAR_MONTH
    </select>
    <select id="PSDrate" resultType="com.wzmtr.eam.dto.res.statistic.FailureRateResDTO">
        select c.YEAR_MONTH as "yearMonth",
               round(
                           (select count(1)
                            from T_FAULT_INFO a
                            where a.MAJOR_CODE = '01'
                              and a.EQUIP_TYPE_CODE in ('010101', '010102', '010104')
                              and substr(a.DISCOVERY_TIME, 1, 7) = c.YEAR_MONTH
                              and rtrim(a.FAULT_FLAG) is null
                              and exists(select 1
                                         from T_FAULT_ORDER b
                                         where b.FAULT_NO = a.FAULT_NO and b.ORDER_STATUS<![CDATA[ <>]]> '99')) /
                           (to_char(last_day(to_date(c.YEAR_MONTH, 'YYYY-MM')), 'dd') * 1464 * 15)
                   , 2)     as "precent"
        from (select to_char(add_months(to_date(#{startTime}, 'YYYY-MM'), rownum - 1), 'YYYY-MM') as YEAR_MONTH
              from dual
                  connect by rownum <![CDATA[ <=]]> months_between(to_date(#{endTime}, 'YYYY-MM'), to_date(#{startTime}, 'YYYY-MM')) + 1) c
        order by c.YEAR_MONTH
    </select>

</mapper>