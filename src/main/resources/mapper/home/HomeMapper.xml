<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wzmtr.eam.mapper.home.HomeMapper">
    <select id="queryB" resultType="com.wzmtr.eam.dto.res.home.ShowBCResDTO">
        SELECT db.NODE_NAME as "majorName",count(b.MAJOR_CODE) as cnt
        from T_EQUIPMENT_CATEGORY	 db
        left join (select d.MAJOR_CODE
        from T_FAULT_INFO d,T_FAULT_ORDER d2
        where d.FAULT_NO=d2.FAULT_NO
        and to_date(d.FILLIN_TIME, 'yyyy-mm-dd hh24:mi:ss') >=      add_months(SYSDATE, -3)
        and d.FAULT_FLAG<![CDATA[ <> ]]>'2'
        <!--作废的故障除外-->
        and d.DELETE_FLAG ='0'
        and d2.ORDER_STATUS<![CDATA[ <> ]]>'99'
        ) b
        on db.NODE_CODE = b.MAJOR_CODE
        where db.PARENT_NODE_REC_ID = '0'
        group by db.NODE_NAME,db.NODE_CODE
        order by cnt desc,db.NODE_CODE
    </select>
    <select id="queryC" resultType="com.wzmtr.eam.dto.res.home.ShowBCResDTO">
        SELECT db.NODE_NAME as "majorName",count(b.MAJOR_CODE) as cnt
        from T_EQUIPMENT_CATEGORY	 db
        left join (select d.MAJOR_CODE
        from T_FAULT_INFO d,T_FAULT_ORDER d2
        where   d.FAULT_NO=d2.FAULT_NO
        and to_date(d.FILLIN_TIME, 'yyyy-mm-dd hh24:mi:ss') -trunc(sysdate) between -7 and 7
        and d.FAULT_FLAG<![CDATA[ <> ]]>'2'
        and d.DELETE_FLAG ='0'
        <!--作废的故障除外-->
        and d2.ORDER_STATUS<![CDATA[ <> ]]>'99'
        ) b
        on db.NODE_CODE = b.MAJOR_CODE
        where db.PARENT_NODE_REC_ID = '0'
        group by db.NODE_NAME,db.NODE_CODE
        order by cnt desc,db.NODE_CODE
    </select>
    <select id="queryA" resultType="com.wzmtr.eam.dto.res.home.ShowAResDTO">
        SELECT t.ORDER_STATUS AS status,
        t.ORDER_STATUS AS cname,count(1) as cnt
        FROM T_FAULT_ORDER t,
        T_FAULT_INFO d
        WHERE 1 = 1
        AND d.FAULT_NO = t.FAULT_NO
        and d.FAULT_FLAG<![CDATA[ <> ]]>'2' and d.DELETE_FLAG ='0'
        <!--作废的故障除外-->
        <!--and t.ORDER_STATUS<![CDATA[ <> ]]>'99'-->
        and to_date(d.FILLIN_TIME,'yyyy-mm-dd hh24:mi:ss') >= add_months(SYSDATE, -3)
        GROUP BY t.ORDER_STATUS
        ORDER BY cnt DESC
    </select>

    <select id="todoList" resultType="com.wzmtr.eam.entity.StatusWorkFlowLog">
        select * from
        T_FLOW_TASK
        where USER_ID=#{userId} and TODO_STATUS=#{type}
        order by KIND_TYPE asc
        <if test="type=='1'">
            , TASK_RCV_TIME desc
        </if>
        <if test="type=='2'">
            , TODO_DATE desc
        </if>
    </select>

    <select id="todoCount" resultType="com.wzmtr.eam.dto.res.home.HomeCountResDTO">
        with todoSize AS (select count(*) as todoSize from
        T_FLOW_TASK
        where USER_ID=#{userId} and TODO_STATUS='1'),
        overSize as (select count(*) as overSize from
        T_FLOW_TASK
        where USER_ID=#{userId} and TODO_STATUS='2')
        SELECT * FROM todoSize, overSize
    </select>

    <update id="urgingTodo">
        update T_FLOW_TASK set
        KIND_TYPE='1'
        where TODO_ID=#{todoId} and TODO_STATUS='1'
    </update>

</mapper>